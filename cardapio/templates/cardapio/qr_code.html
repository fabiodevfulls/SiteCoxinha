{% extends 'cardapio/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <h2 class="mb-4">Pagamento via PIX</h2>
            
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- QR Code -->
                    <div class="mb-4">
                        <img src="data:image/png;base64,{{ qr_code_base64 }}" 
                             alt="QR Code PIX" 
                             class="img-fluid mx-auto d-block"
                             style="max-width: 300px;">
                    </div>
                    
                    <!-- Código PIX Copiável -->
                    <div class="mb-4">
                        <p class="text-muted">Código PIX (copie e cole no seu aplicativo):</p>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control text-center" 
                                   id="pix-code" 
                                   value="{{ qr_code }}" 
                                   readonly>
                            <button class="btn btn-outline-primary" onclick="copiarPixCode()">
                                <i class="bi bi-clipboard"></i> Copiar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Informações do Pagamento -->
                    <div class="alert alert-info text-start">
                        <h5 class="alert-heading">Instruções:</h5>
                        <ol>
                            <li>Abra seu aplicativo de pagamentos</li>
                            <li>Selecione a opção PIX</li>
                            <li>Escaneie o QR Code ou cole o código</li>
                            <li>Confirme o pagamento de R$ {{ pedido.total|floatformat:2 }}</li>
                        </ol>
                        <p class="mb-0">O status será atualizado automaticamente após a confirmação.</p>
                    </div>
                    
                    <!-- Status do Pagamento -->
                    <div id="payment-status" class="my-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Aguardando pagamento...</span>
                        </div>
                        <p class="mt-2">Aguardando confirmação do pagamento...</p>
                    </div>
                    
                    <!-- Botões de Ação -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                        <a href="{% url 'pagamento_falhou' pedido.id %}" class="btn btn-outline-danger me-md-2">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <a href="{% url 'menu' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar ao Cardápio
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="pedido-id" value="{{ pedido.id }}">
{% endblock %}

{% block scripts %}
<script>
// Função para copiar código PIX
function copiarPixCode() {
    const pixCode = document.getElementById('pix-code');
    pixCode.select();
    document.execCommand('copy');
    
    // Feedback visual
    const originalText = pixCode.value;
    pixCode.value = "Copiado!";
    setTimeout(() => {
        pixCode.value = originalText;
    }, 2000);
}

// Verificar status do pagamento periodicamente
function verificarStatusPagamento() {
    const pedidoId = document.getElementById('pedido-id').value;
    const statusContainer = document.getElementById('payment-status');
    
    const interval = setInterval(() => {
        fetch(`/api/verificar-status/${pedidoId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'approved') {
                    clearInterval(interval);
                    statusContainer.innerHTML = `
                        <div class="alert alert-success">
                            <h4><i class="bi bi-check-circle-fill"></i> Pagamento Confirmado!</h4>
                            <p>Redirecionando para a página de confirmação...</p>
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.href = `/pagamento/aprovado/${pedidoId}/`;
                    }, 3000);
                } else if (data.status === 'rejected') {
                    clearInterval(interval);
                    statusContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <h4><i class="bi bi-exclamation-circle-fill"></i> Pagamento Não Aprovado</h4>
                            <p>Por favor, tente novamente ou escolha outra forma de pagamento.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
            });
    }, 5000); // Verificar a cada 5 segundos
}

// Iniciar verificação quando a página carregar
document.addEventListener('DOMContentLoaded', verificarStatusPagamento);
</script>
{% endblock %}